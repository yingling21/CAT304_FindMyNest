"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.getActiveMatchingSurveys=getActiveMatchingSurveys;var _surveysUtils=require("./surveys-utils");var _nativeDeps=require("../native-deps");var _core=require("@posthog/core");var ANY_FLAG_VARIANT='any';var isMatchingRegex=function isMatchingRegex(value,pattern){if(!isValidRegex(pattern)){return false;}try{return new RegExp(pattern).test(value);}catch(_a){return false;}};var isValidRegex=function isValidRegex(str){try{new RegExp(str);}catch(_a){return false;}return true;};var surveyValidationMap={icontains:function icontains(targets,value){return targets.some(function(target){return value.toLowerCase().includes(target.toLowerCase());});},not_icontains:function not_icontains(targets,value){return targets.every(function(target){return!value.toLowerCase().includes(target.toLowerCase());});},regex:function regex(targets,value){return targets.some(function(target){return isMatchingRegex(value,target);});},not_regex:function not_regex(targets,value){return targets.every(function(target){return!isMatchingRegex(value,target);});},exact:function exact(targets,value){return targets.some(function(target){return value===target;});},is_not:function is_not(targets,value){return targets.every(function(target){return value!==target;});}};function defaultMatchType(matchType){return matchType!==null&&matchType!==void 0?matchType:_core.SurveyMatchType.Icontains;}function doesSurveyDeviceTypesMatch(survey){var _a;if(!((_a=survey.conditions)===null||_a===void 0?void 0:_a.deviceTypes)||survey.conditions.deviceTypes.length===0){return true;}var deviceType=_nativeDeps.currentDeviceType;return surveyValidationMap[defaultMatchType(survey.conditions.deviceTypesMatchType)](survey.conditions.deviceTypes,deviceType);}function isSurveyFlagEnabled(flagKey,flags){return flagKey?!!flags[flagKey]===true:true;}function getActiveMatchingSurveys(surveys,flags,seenSurveys,activatedSurveys){return surveys.filter(function(survey){var _a,_b,_c,_d,_e;if(!survey.start_date||survey.end_date){return false;}if(!doesSurveyDeviceTypesMatch(survey)){return false;}if(seenSurveys.includes(survey.id)&&!(0,_surveysUtils.canActivateRepeatedly)(survey)){return false;}if(((_a=survey.conditions)===null||_a===void 0?void 0:_a.url)&&survey.conditions.url!==''||((_b=survey.conditions)===null||_b===void 0?void 0:_b.selector)&&survey.conditions.selector!==''){return false;}if(!survey.linked_flag_key&&!survey.targeting_flag_key&&!survey.internal_targeting_flag_key&&!((_c=survey.feature_flag_keys)===null||_c===void 0?void 0:_c.length)){return true;}var linkedFlagCheck=isSurveyFlagEnabled(survey.linked_flag_key,flags);var linkedFlagVariant=(_d=survey.conditions)===null||_d===void 0?void 0:_d.linkedFlagVariant;var linkedFlagVariantCheck=true;if(linkedFlagVariant){linkedFlagVariantCheck=survey.linked_flag_key?flags[survey.linked_flag_key]===linkedFlagVariant||linkedFlagVariant===ANY_FLAG_VARIANT:true;}var targetingFlagCheck=isSurveyFlagEnabled(survey.targeting_flag_key,flags);var eventBasedTargetingFlagCheck=(0,_surveysUtils.hasEvents)(survey)?activatedSurveys.has(survey.id):true;var internalTargetingFlagCheck=survey.internal_targeting_flag_key&&!(0,_surveysUtils.canActivateRepeatedly)(survey)?isSurveyFlagEnabled(survey.internal_targeting_flag_key,flags):true;var flagsCheck=((_e=survey.feature_flag_keys)===null||_e===void 0?void 0:_e.length)?survey.feature_flag_keys.every(function(_ref){var key=_ref.key,value=_ref.value;return!key||!value||isSurveyFlagEnabled(value,flags);}):true;return linkedFlagCheck&&linkedFlagVariantCheck&&targetingFlagCheck&&internalTargetingFlagCheck&&eventBasedTargetingFlagCheck&&flagsCheck;});}