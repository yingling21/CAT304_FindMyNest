"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");var _typeof=require("@babel/runtime/helpers/typeof");Object.defineProperty(exports,"__esModule",{value:true});exports.Questions=Questions;exports.sendSurveyShownEvent=exports.sendSurveyEvent=exports.dismissedSurveyEvent=void 0;var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));var _toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));var _defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));var _react=_interopRequireWildcard(require("react"));var _reactNative=require("react-native");var _surveysUtils=require("../surveys-utils");var _core=require("@posthog/core");var _QuestionTypes=require("./QuestionTypes");var _usePostHog=require("../../hooks/usePostHog");var _jsxRuntime=require("react/jsx-runtime");var _jsxFileName="/home/runner/work/posthog-js/posthog-js/packages/react-native/dist/surveys/components/Surveys.js",_this=void 0;function _interopRequireWildcard(e,t){if("function"==typeof WeakMap)var r=new WeakMap(),n=new WeakMap();return(_interopRequireWildcard=function _interopRequireWildcard(e,t){if(!t&&e&&e.__esModule)return e;var o,i,f={__proto__:null,"default":e};if(null===e||"object"!=_typeof(e)&&"function"!=typeof e)return f;if(o=t?n:r){if(o.has(e))return o.get(e);o.set(e,f);}for(var _t2 in e)"default"!==_t2&&{}.hasOwnProperty.call(e,_t2)&&((i=(o=Object.defineProperty)&&Object.getOwnPropertyDescriptor(e,_t2))&&(i.get||i.set)?o(f,_t2,i):f[_t2]=e[_t2]);return f;})(e,t);}function ownKeys(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);r&&(o=o.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable;})),t.push.apply(t,o);}return t;}function _objectSpread(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?ownKeys(Object(t),!0).forEach(function(r){(0,_defineProperty2["default"])(e,r,t[r]);}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):ownKeys(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r));});}return e;}var getSurveyInteractionProperty=function getSurveyInteractionProperty(survey,action){var surveyProperty="$survey_".concat(action,"/").concat(survey.id);if(survey.current_iteration&&survey.current_iteration>0){surveyProperty="$survey_".concat(action,"/").concat(survey.id,"/").concat(survey.current_iteration);}return surveyProperty;};var sendSurveyShownEvent=exports.sendSurveyShownEvent=function sendSurveyShownEvent(survey,posthog){posthog.capture('survey shown',_objectSpread(_objectSpread({$survey_name:survey.name,$survey_id:survey.id},(0,_core.maybeAdd)('$survey_iteration',survey.current_iteration)),(0,_core.maybeAdd)('$survey_iteration_start_date',survey.current_iteration_start_date)));};function getSurveyNewResponseKey(questionId){return"$survey_response_".concat(questionId);}function getSurveyOldResponseKey(originalQuestionIndex){return originalQuestionIndex===0?'$survey_response':"$survey_response_".concat(originalQuestionIndex);}var getSurveyResponseValue=function getSurveyResponseValue(responses,questionId){if(!questionId){return null;}var response=responses[getSurveyNewResponseKey(questionId)];if(Array.isArray(response)){return(0,_toConsumableArray2["default"])(response);}return response;};var sendSurveyEvent=exports.sendSurveyEvent=function sendSurveyEvent(){var responses=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var survey=arguments.length>1?arguments[1]:undefined;var posthog=arguments.length>2?arguments[2]:undefined;var oldFormatResponses={};survey.questions.forEach(function(question){var oldResponseKey=getSurveyOldResponseKey(question.originalQuestionIndex);var response=getSurveyResponseValue(responses,question.id);if(!(0,_core.isUndefined)(response)){oldFormatResponses[oldResponseKey]=response;}});var allResponses=_objectSpread(_objectSpread({},responses),oldFormatResponses);posthog.capture('survey sent',_objectSpread(_objectSpread(_objectSpread(_objectSpread({$survey_name:survey.name,$survey_id:survey.id},(0,_core.maybeAdd)('$survey_iteration',survey.current_iteration)),(0,_core.maybeAdd)('$survey_iteration_start_date',survey.current_iteration_start_date)),{},{$survey_questions:survey.questions.map(function(question){return{id:question.id,question:question.question,response:getSurveyResponseValue(responses,question.id)};})},allResponses),{},{$set:(0,_defineProperty2["default"])({},getSurveyInteractionProperty(survey,'responded'),true)}));};var dismissedSurveyEvent=exports.dismissedSurveyEvent=function dismissedSurveyEvent(survey,posthog){posthog.capture('survey dismissed',_objectSpread(_objectSpread(_objectSpread({$survey_name:survey.name,$survey_id:survey.id},(0,_core.maybeAdd)('$survey_iteration',survey.current_iteration)),(0,_core.maybeAdd)('$survey_iteration_start_date',survey.current_iteration_start_date)),{},{$set:(0,_defineProperty2["default"])({},getSurveyInteractionProperty(survey,'dismissed'),true)}));};function Questions(_ref){var survey=_ref.survey,appearance=_ref.appearance,styleOverrides=_ref.styleOverrides,onSubmit=_ref.onSubmit;var _useState=(0,_react.useState)({}),_useState2=(0,_slicedToArray2["default"])(_useState,2),questionsResponses=_useState2[0],setQuestionsResponses=_useState2[1];var _useState3=(0,_react.useState)(0),_useState4=(0,_slicedToArray2["default"])(_useState3,2),currentQuestionIndex=_useState4[0],setCurrentQuestionIndex=_useState4[1];var surveyQuestions=(0,_react.useMemo)(function(){return(0,_surveysUtils.getDisplayOrderQuestions)(survey);},[survey]);var posthog=(0,_usePostHog.usePostHog)();var onNextButtonClick=function onNextButtonClick(_ref2){var res=_ref2.res,originalQuestionIndex=_ref2.originalQuestionIndex,questionId=_ref2.questionId;var responseKey=getSurveyNewResponseKey(questionId);var allResponses=_objectSpread(_objectSpread({},questionsResponses),{},(0,_defineProperty2["default"])({},responseKey,res));setQuestionsResponses(allResponses);var nextStep=(0,_surveysUtils.getNextSurveyStep)(survey,originalQuestionIndex,res);if(nextStep===_core.SurveyQuestionBranchingType.End){sendSurveyEvent(allResponses,survey,posthog);onSubmit();}else{setCurrentQuestionIndex(nextStep);}};var question=surveyQuestions[currentQuestionIndex];return(0,_jsxRuntime.jsx)(_reactNative.ScrollView,{style:[styleOverrides,{flexGrow:0}],children:getQuestionComponent({question:question,appearance:appearance,onSubmit:function onSubmit(res){return onNextButtonClick({res:res,originalQuestionIndex:question.originalQuestionIndex,questionId:question.id});}})});}var getQuestionComponent=function getQuestionComponent(props){var questionComponents={open:_QuestionTypes.OpenTextQuestion,link:_QuestionTypes.LinkQuestion,rating:_QuestionTypes.RatingQuestion,multiple_choice:_QuestionTypes.MultipleChoiceQuestion,single_choice:_QuestionTypes.MultipleChoiceQuestion};var Component=questionComponents[props.question.type];return(0,_jsxRuntime.jsx)(Component,_objectSpread({},props),props.question.originalQuestionIndex);};